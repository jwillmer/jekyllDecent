---
layout:            post
title:             "주키퍼란 무엇인가"
menutitle:         "주키퍼란 무엇인가"
category:          BigData
author:            geunyoung
cover:             /assets/mountain-alternative-cover.jpg
published:         true
language:          KO
comments:          true
---
 
  
### 세팅에 앞서...
  
  최근에 빅데이터 시스템을 관리하게 되면서 주키퍼 시스템에 대해 정말 많이 마주치게 되었다. 처음에는 단순히 hadoop 시스템의 일부분으로만 알고 있었지만 Kafka와 쓰인다던지 Hbase로 쓰인다던지 많이 마주치게 되면서 주키퍼에 대한 개념과 설정방법을 공부해야 하겠다는 생각이 들었다.
    
### 주키퍼란 무엇인가
  
  주키퍼는(Zookeeper)는 Apache에서 만든 **분산 코디네이션 서비스**를 제공하는 오픈소스 프로젝트이다. 조금 더 쉽게 설명하자면 분산처리 시스템에서는 데이터를 분산시켜 여기저기서 저장을 하는데 어떤 데이터가 어디에 있는지에 대한 정보를 가지고 있는 시스템이 필요하다. 그 시스템이 바로 주키퍼이다.
  
### 주키퍼의 특징
  
  분산 시스템은 주로 엄청난 데이터를 처리한다. 그러기 위해선 처리 속도가 빨라야 한다. 그래서 주키퍼는 다중의 주키퍼 서버를 통해서 병렬식 처리를 한다.
  
 * ###### 특징1 : 병렬 처리를 한다.
 
 병렬처리를 하게 되면 또 다른 문제에 국면한다. 같은 작업을 2개의 서버에서 진행해버리는 문제가 있을 수 있고 건들고 있는 데이터를 다른 서버에서 건드는 문제가 발생 할 수 있다. 이 문제를 해결하기 위해 Locking and synchronization service를 제공한다. 즉, 건들고 있는 데이터나 처리하는 데이터에 대해서는 다른 서버가 못건들게 하는 방법이다.
 
 * ###### 특징2 : 동기화 서비스(Locking and synchronization service)
 
 그러면 서버들에게 '건들지 마라', '쓰고 있다', '너가 먼저 처리해라'라는 것을 판단해줄 무언가가 필요해진다. 또한, 서버들이 같은 데이터를 가지고 있어야한다(동기화). 그래서 주키퍼는 Follower와 Leader의 개념을 도입하였다. 아래의 그림을 통해 이해를 해보자.
   
<figure>
<img src="{{ "/media/img/Bigdata/zookeeper.PNG" | absolute_url }}" />
<figcaption>출처 :https://engkimbs.tistory.com/660 </figcaption>
</figure>
  
주키퍼의 앙상블(Ensemble)이라고도 불리는 이 로직을 통해 데이터를 읽거나 데이터를 업데이트하여, 서버들은 항상 동일한 데이터를 가지고 있게된다.
 
 * ###### 특징3,4 : 클러스터 관리(Cluster management), 설정 관리(Configuration management)
 
그러면 리더는 어떻게 뽑을까? 각 주키퍼 서버들이 내부 로직을 통해 누가 리더가 될지 투표를 하며 과반수에 투표가 된 주키퍼 서버가 Leader가 된다. 이를 다른 말로 퀀텀이라 부른다. 이러한 로직에 의해 주키퍼는 늘 홀수의 서버 개수로 세팅되어야 하며, 세팅된 서버의 과반수가 죽는 경우 주키퍼가 정상작동 하지 않는다는 특정이 있다.
 
 * ###### 특징3,4 : 리더 채택(Leader selection)


21. 서버2의 네임노드 스탠바이로 설정  
서버2로 들어가서
```text
./bin/hdfs namenode -bootstrapStandby
```
  
22. 서버1,2로 가서 네임노드 실행
```text
./sbin/hadoop-daemon.sh start namenode
```

23. 서버1,2에서 주키퍼 컨트롤러 실행
```text
./sbin/hadoop-daemon.sh start zkfc
```
  
24. 데이터노드 실행
```text
책에서는 서버1 실행시키면 2,3,4 실행이 된다고 적혀있었지만 난 안되었음. 직접가서 2,3,4 실행 했고 문제없이 돌아가는 것 확인
./sbin/hadoop-daemon.sh start datanode
```
  
25. hdfs잘 작동하는지 디렉토리 만들며 테스트
```text
./sbin/hdfs dfs -ls /
./sbin/hdfs dfs -mkdir /user
./sbin/hdfs dfs -mkdir /user/hadoop
./sbin/hdfs dfs -mkdir /user/hadoop/conf
./sbin/hdfs dfs -put ../../../../hadoop-2.7.7/etc/hadoop/hadoop-env.sh /user/hadoop/conf/
./sbin/hdfs dfs -ls conf
```
  
26. 얀 클러스터 실행
```text
./sbin/start-yarn.sh
이것도 서버1 실행시키면 2,3 실행이 된다고 적혀있었지만 난 안되었음. 직접가서 2,3 실행 했고 문제없이 돌아가는 것 확인
```
  
27. 맵리듀스 잡을 위한 히스토이 서버 실행
```text
mr-jobhistory-daemon.sh start historyserver
```

28. jps를 통해 제대로 켜져있는지 확인
```text
서버1,2는 Jps, DFSZKFailoverController, Namenode, ResourceManager, JobHistoryServer, JournalNode, DataNode, NodeManager가 켜져있어야 하고, 서버3,4는 Jps, DataNode, NodeManager, JournalNode가 켜져 있어야한다.
```
  
29. 예제를 통한 정상 작동 확인
```text
./bin/yarn jar share/hadoop/mapreduce/hadoop-mapreduce-examples-2.6.0.jar wordcount conf output
```


##### xml 샘플들
  
###### core-site.xml

```xml
<configuration>
 <property>
  <name>fs.defaultFS</name>
  <value>hdfs://servers-cluster</value>
 </property>

 <property>
  <name>ha.zookeeper.quorum</name>
  <value>server1:2181,server2:2181,server3:2181</value>
 </property>
</configuration>
```
  
###### hdfs-site.xml

```xml
<configuration>
 <property>
  <name>dfs.namenode.name.dir</name>
  <value>/home/hadoop/data/dfs/namenode</value>
 </property>

 <property>
  <name>dfs.datanode.data.dir</name>
  <value>/home/hadoop/data/dfs/datanode</value>
 </property>

 <property>
  <name>dfs.journalnode.edits.dir</name>
  <value>/home/hadoop/data/dfs/journalnode</value>
 </property>

 <property>
  <name>dfs.nameservices</name>
  <value>servers-cluster</value>
 </property>

 <property>
  <name>dfs.ha.namenodes.servers-cluster</name>
  <value>nn1,nn2</value>
 </property>

 <property>
  <name>dfs.namenode.rpc-address.servers-cluster.nn1</name>
  <value>server1:8020</value>
 </property>

 <property>
  <name>dfs.namenode.rpc-address.servers-cluster.nn2</name>
  <value>server2:8020</value>
 </property>

 <property>
  <name>dfs.namenode.http-address.servers-cluster.nn1</name>
  <value>server1:50070</value>
 </property>

 <property>
  <name>dfs.namenode.http-address.servers-cluster.nn2</name>
  <value>server2:5070</value>
 </property>

 <property>
  <name>dfs.namenode.shared.edits.dir</name>
  <value>qjournal://server1:8485;server2:8485;server3:8485/servers-cluster</value>
 </property>

 <property>
  <name>dfs.client.failover.proxy.provider.servers-cluster</name>
  <value>org.apache.hadoop.hdfs.server.namenode.ha.ConfiguredFailoverProxyProvider</value>
 </property>

 <property>
  <name>dfs.ha.fencing.methods</name>
  <value>sshfence</value>
 </property>

 <property>
  <name>dfs.ha.ssh.private-key-files</name>
  <value>/home/hadoop/.ssh/id_rsa</value>
 </property>


 <property>
  <name>dfs.ha.automatic-failover.enabled</name>
  <value>true</value>
 </property>
</configuration>
```
  
  
### 잘못 알고 있었던 정보 / 헷갈려던 부분
  
 * ###### ZooKeeper가 서버들을 동기화 시켜준다?
  >책을 보면서 공부를 진행하는 중인데 책이 Hadoop에 관한 책이여서 리눅스는 관련된 세팅과 작업들은 가볍게 언급하거나 알아서 세팅해야 했다. 이전 회사에서 어플리케이션 개발에 주업무였던 나는 리눅스 세팅에도 많은 시간이 투자되어 블로그에도 최대한 리눅스 관련 세팅도 작성하려 했다.

 * ###### Kafka사버와 브로커는 동일 개념?
  >책을 보면서 공부를 진행하는 중인데 책이 Hadoop에 관한 책이여서 리눅스는 관련된 세팅과 작업들은 가볍게 언급하거나 알아서 세팅해야 했다. 이전 회사에서 어플리케이션 개발에 주업무였던 나는 리눅스 세팅에도 많은 시간이 투자되어 블로그에도 최대한 리눅스 관련 세팅도 작성하려 했다.

### 참고한 사이트 및 이미지 링크
  
 * https://engkimbs.tistory.com/660
